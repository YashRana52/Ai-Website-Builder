"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.purchaseCredits = exports.togglePublish = exports.getUserProjects = exports.getUserProject = exports.createUserProject = exports.getUserCredits = void 0;
const prisma_js_1 = __importDefault(require("../lib/prisma.js"));
const openai_js_1 = __importDefault(require("../configs/openai.js"));
const stripe_1 = __importDefault(require("stripe"));
//Get user credits
const getUserCredits = async (req, res) => {
    try {
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({
                message: "Unauthorized",
            });
        }
        const user = await prisma_js_1.default.user.findUnique({
            where: { id: userId },
            select: { credits: true }, // ðŸ”¥ optimized
        });
        if (!user) {
            return res.status(404).json({
                message: "User not found",
            });
        }
        res.json({
            credits: user.credits ?? 0,
        });
    }
    catch (error) {
        console.log(error.code || error.message);
        res.status(500).json({
            message: "Failed to fetch user credits",
        });
    }
};
exports.getUserCredits = getUserCredits;
// controller Function to create new project
const createUserProject = async (req, res) => {
    const userId = req.userId;
    try {
        const { initial_prompt } = req.body;
        if (!userId) {
            return res.status(401).json({
                message: "Unauthorized",
            });
        }
        const user = await prisma_js_1.default.user.findUnique({
            where: { id: userId },
        });
        if (user && user.credits < 5) {
            return res.status(403).json({
                message: "add credits to create more projects",
            });
        }
        // Create a new project
        const project = await prisma_js_1.default.websiteProject.create({
            data: {
                name: initial_prompt.length > 50
                    ? initial_prompt.substring(0, 47) + "..."
                    : initial_prompt,
                initial_prompt,
                userId,
            },
        });
        // updates user total creation
        await prisma_js_1.default.user.update({
            where: { id: userId },
            data: { totalCreation: { increment: 1 } },
        });
        await prisma_js_1.default.conversation.create({
            data: {
                role: "user",
                content: initial_prompt,
                projectId: project.id,
            },
        });
        await prisma_js_1.default.user.update({
            where: { id: userId },
            data: { credits: { decrement: 5 } },
        });
        res.json({
            projectId: project.id,
        });
        //  user prompt ko enhance krte h phle
        const promptEnhanceResponse = await openai_js_1.default.chat.completions.create({
            model: "z-ai/glm-4.5-air:free",
            messages: [
                {
                    role: "system",
                    content: `
You are a prompt enhancement specialist. Take the user's website request and expand it into a detailed, comprehensive prompt that will help create the best possible website.

Enhance this prompt by:
1. Adding specific design details (layout, color scheme, typography)
2. Specifying key sections and features
3. Describing the user experience and interactions
4. Including modern web design best practices
5. Mentioning responsive design requirements
6. Adding any missing but important elements

Return ONLY the enhanced prompt, nothing else. Make it detailed but concise (2-3 paragraphs max).
`,
                },
                {
                    role: "user",
                    content: initial_prompt,
                },
            ],
        });
        const enhancedPrompt = promptEnhanceResponse.choices[0].message.content;
        await prisma_js_1.default.conversation.create({
            data: {
                role: "assistant",
                content: `I've enhanced your prompt to "${enhancedPrompt}" `,
                projectId: project.id,
            },
        });
        await prisma_js_1.default.conversation.create({
            data: {
                role: "assistant",
                content: "now generating your website...",
                projectId: project.id,
            },
        });
        //Generate website code
        const codeGenerationResponse = await openai_js_1.default.chat.completions.create({
            model: "z-ai/glm-4.5-air:free",
            messages: [
                {
                    role: "system",
                    content: `You are an expert web developer. Create a complete, production-ready, single-page website based on this request: "${enhancedPrompt}"

    CRITICAL REQUIREMENTS:
    - You MUST output valid HTML ONLY. 
    - Use Tailwind CSS for ALL styling
    - Include this EXACT script in the <head>: <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    - Use Tailwind utility classes extensively for styling, animations, and responsiveness
    - Make it fully functional and interactive with JavaScript in <script> tag before closing </body>
    - Use modern, beautiful design with great UX using Tailwind classes
    - Make it responsive using Tailwind responsive classes (sm:, md:, lg:, xl:)
    - Use Tailwind animations and transitions (animate-*, transition-*)
    - Include all necessary meta tags
    - Use Google Fonts CDN if needed for custom fonts
    - Use placeholder images from https://placehold.co/600x400
    - Use Tailwind gradient classes for beautiful backgrounds
    - Make sure all buttons, cards, and components use Tailwind styling

    CRITICAL HARD RULES:
    1. You MUST put ALL output ONLY into message.content.
    2. You MUST NOT place anything in "reasoning", "analysis", "reasoning_details", or any hidden fields.
    3. You MUST NOT include internal thoughts, explanations, analysis, comments, or markdown.
    4. Do NOT include markdown, explanations, notes, or code fences.

    The HTML should be complete and ready to render as-is with Tailwind CSS.`,
                },
                {
                    role: "user",
                    content: enhancedPrompt || "",
                },
            ],
        });
        const code = codeGenerationResponse.choices[0].message.content || "";
        if (!code) {
            await prisma_js_1.default.conversation.create({
                data: {
                    role: "assistant",
                    content: "Unable to generate the code,please try again",
                    projectId: project.id,
                },
            });
            await prisma_js_1.default.user.update({
                where: { id: userId },
                data: {
                    credits: { increment: 5 },
                },
            });
            return;
        }
        // Create Version for the project
        const version = await prisma_js_1.default.version.create({
            data: {
                code: code
                    .replace(/```[a-z]*\n?/gi, "")
                    .replace(/```$/g, "")
                    .trim(),
                description: "Initial version",
                projectId: project.id,
            },
        });
        await prisma_js_1.default.conversation.create({
            data: {
                role: "assistant",
                content: "I've created your website You can now preview it and request any changes.",
                projectId: project.id,
            },
        });
        await prisma_js_1.default.websiteProject.update({
            where: { id: project.id },
            data: {
                current_code: code
                    .replace(/```[a-z]*\n?/gi, "")
                    .replace(/```$/g, "")
                    .trim(),
                current_version_index: version.id,
            },
        });
    }
    catch (error) {
        await prisma_js_1.default.user.update({
            where: { id: userId },
            data: { credits: { increment: 5 } },
        });
        console.log(error.code || error.message);
        res.status(500).json({
            message: error.message,
        });
    }
};
exports.createUserProject = createUserProject;
// controller function to get single user project
const getUserProject = async (req, res) => {
    try {
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({
                message: "Unauthorized",
            });
        }
        const { projectId } = req.params;
        const project = await prisma_js_1.default.websiteProject.findFirst({
            where: {
                id: projectId,
                userId,
            },
            include: {
                conversation: {
                    orderBy: {
                        timestamp: "asc",
                    },
                },
                versions: {
                    orderBy: {
                        timestamp: "asc",
                    },
                },
            },
        });
        if (!project) {
            return res.status(404).json({
                message: "Project not found",
            });
        }
        res.json({ project });
    }
    catch (error) {
        console.log(error.code || error.message);
        res.status(500).json({
            message: "Failed to fetch project",
        });
    }
};
exports.getUserProject = getUserProject;
//controller function to user to get all users Projects
const getUserProjects = async (req, res) => {
    try {
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({ message: "Unauthorized" });
        }
        const projects = await prisma_js_1.default.websiteProject.findMany({
            where: { userId },
            orderBy: { updatedAt: "desc" },
            select: {
                id: true,
                name: true,
                updatedAt: true,
                createdAt: true,
                current_version_index: true,
                current_code: true, // âœ… add this line
                initial_prompt: true, // optional: if frontend uses it
                user: {
                    select: {
                        name: true, // optional: if frontend uses it
                    },
                },
            },
        });
        res.status(200).json({
            projects,
        });
    }
    catch (error) {
        console.error(error);
        res.status(500).json({
            message: "Failed to fetch projects",
        });
    }
};
exports.getUserProjects = getUserProjects;
//controller function to toggle project Publish
const togglePublish = async (req, res) => {
    try {
        const userId = req.userId;
        if (!userId) {
            return res.status(401).json({ message: "Unauthorized" });
        }
        const { projectId } = req.params;
        const project = await prisma_js_1.default.websiteProject.findFirst({
            where: {
                id: projectId,
                userId,
            },
        });
        if (!project) {
            return res.status(404).json({ message: "Project not found" });
        }
        const updatedProject = await prisma_js_1.default.websiteProject.update({
            where: {
                id: projectId,
            },
            data: {
                isPublished: !project.isPublished,
            },
        });
        res.json({
            isPublished: updatedProject.isPublished,
            message: updatedProject.isPublished
                ? "Project Published Successfully"
                : "Project Unpublished",
        });
    }
    catch (error) {
        console.log(error.code || error.message);
        res.status(500).json({ message: error.message });
    }
};
exports.togglePublish = togglePublish;
// controller function to puchase credits
const purchaseCredits = async (req, res) => {
    try {
        const plans = {
            basic: {
                credits: 100,
                amount: 5,
            },
            pro: {
                credits: 400,
                amount: 19,
            },
            enterprise: {
                credits: 1000,
                amount: 49,
            },
        };
        const userId = req.userId;
        const { planId } = req.body;
        const origin = req.headers.origin;
        const plan = plans[planId];
        if (!plan) {
            return res.status(404).json({
                message: "plan not found",
            });
        }
        const transaction = await prisma_js_1.default.transaction.create({
            data: {
                userId: userId,
                planId: req.body.planId,
                amount: plan.amount,
                credits: plan.credits,
            },
        });
        const stripe = new stripe_1.default(process.env.STRIPE_SECRET_KEY);
        const session = await stripe.checkout.sessions.create({
            success_url: `${origin}/loading`,
            cancel_url: `${origin}`,
            line_items: [
                {
                    price_data: {
                        currency: "usd",
                        product_data: {
                            name: `SiteBuilder - ${plan.credits} credits`,
                        },
                        unit_amount: Math.floor(transaction.amount) * 100,
                    },
                    quantity: 1,
                },
            ],
            mode: "payment",
            metadata: {
                transactionId: transaction.id,
                appId: "Site-Builder",
            },
            expires_at: Math.floor(Date.now() / 1000) + 30 * 60, // 30 min expire
        });
        res.json({
            payment_link: session.url,
        });
    }
    catch (error) {
        console.log(error.code || error.message);
        res.status(500).json({ message: error.message });
    }
};
exports.purchaseCredits = purchaseCredits;
